

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Long Short Term Memory (LSTM) Cell &mdash; embARC Machine Learning Inference Library 1.00 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/style_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transform Group" href="transform_grp.html" />
    <link rel="prev" title="Basic RNN Cell" href="comm_basic_rnn.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> embARC Machine Learning Inference Library
          

          
          </a>

          
            
            
              <div class="version">
                1.00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../library_model/library_model.html">Library Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MLI_FP_data_format/MLI_FP_data_format.html">MLI Fixed-Point Data Format</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="MLI_kernels.html">MLI Kernels</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="convolution_grp.html">Convolution Group</a></li>
<li class="toctree-l2"><a class="reference internal" href="pooling_grp.html">Pooling Group</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="common_grp.html">Common Group</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="comm_fully_connected.html">Fully Connected</a></li>
<li class="toctree-l3"><a class="reference internal" href="comm_basic_rnn.html">Basic RNN Cell</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Long Short Term Memory (LSTM) Cell</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#function-configuration-structure">Function Configuration Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kernel-interface">Kernel Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kernel-specializations">Kernel Specializations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conditions-for-applying-the-kernel">Conditions for Applying the Kernel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="transform_grp.html">Transform Group</a></li>
<li class="toctree-l2"><a class="reference internal" href="elementwise_grp.html">Element-wise Group</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_manipulation_grp.html">Data Manipulation Group</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../MLI_helpers/MLI_helpers.html">MLI Helpers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">embARC Machine Learning Inference Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="MLI_kernels.html">MLI Kernels</a> &raquo;</li>
        
          <li><a href="common_grp.html">Common Group</a> &raquo;</li>
        
      <li>Long Short Term Memory (LSTM) Cell</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/MLI_kernels/comm_lstm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="long-short-term-memory-lstm-cell">
<span id="lstm"></span><h1>Long Short Term Memory (LSTM) Cell<a class="headerlink" href="#long-short-term-memory-lstm-cell" title="Permalink to this headline">¶</a></h1>
<img alt="Long Short Term Memory Schematic Representation" class="align-center" src="../_images/image119.png" />
<p>This kernel implements the default non-peephole implementation of
Long short term memory cell.</p>
<p>The LSTM operation is described by the following formulas:</p>
<div class="math notranslate nohighlight">
\[{i_{t} = sigm\left( x_{t}W_{\text{xi}} + h_{t - 1}W_{\text{hi}} + b_{i} \right)}\]</div>
<div class="math notranslate nohighlight">
\[{f_{t} = sigm\left( x_{t}W_{\text{xf}} + h_{t - 1}W_{\text{hf}} + b_{f} \right)}\]</div>
<div class="math notranslate nohighlight">
\[{o_{t} = sigm\left( x_{t}W_{\text{xo}} + h_{t - 1}W_{\text{ho}} + b_{o} \right)}\]</div>
<div class="math notranslate nohighlight">
\[{g_{t} = tanh\left( x_{t}W_{\text{xg}} + h_{t - 1}W_{\text{hg}} + b_{g} \right)}\]</div>
<div class="math notranslate nohighlight">
\[{C_{t} = g_{t}*i_{t} + f_{t}*C_{t - 1}}\]</div>
<div class="math notranslate nohighlight">
\[{h_{t} = o_{t}\ *o\_ act(C_{t})}\]</div>
<dl class="docutils">
<dt>where:</dt>
<dd><ul class="first last simple">
<li><span class="math notranslate nohighlight">\(\ x_{t}\ \)</span> - frame <span class="math notranslate nohighlight">\(t\)</span> in input sequence.</li>
<li><span class="math notranslate nohighlight">\(\ h_{t}\ \)</span> - cell output for frame <span class="math notranslate nohighlight">\(t\)</span> in input sequence.</li>
<li><span class="math notranslate nohighlight">\(i_{t}\ ,\ f_{t}\ ,\ o_{t}\)</span> – input, forget, output gate subtensors for frame <span class="math notranslate nohighlight">\(t\)</span> in input sequence.</li>
<li><span class="math notranslate nohighlight">\(\ g_{t}\ \)</span> - new cell candidates for frame <span class="math notranslate nohighlight">\(t\)</span> in input sequence.</li>
<li><span class="math notranslate nohighlight">\(\ C_{t}\ \)</span> - cell state for frame <span class="math notranslate nohighlight">\(t\)</span> in input sequence.</li>
<li><span class="math notranslate nohighlight">\(W_{**}\ \)</span> - weights for appropriate input subtensor.</li>
<li><span class="math notranslate nohighlight">\(b_{*}\ \)</span> - bias for appropriate input subtensor.</li>
<li><span class="math notranslate nohighlight">\(\ sigm\ , tanh\ \)</span> - sigmoid and hyperbolic tangent activation functions.</li>
<li><span class="math notranslate nohighlight">\(o\_ act\)</span> – output activation function.</li>
</ul>
</dd>
</dl>
<p>In the figure, <em>N</em> is the total number of elements in the input and M
is the total number of elements in the cell output.</p>
<p>This kernel supports the following output activation types (<span class="math notranslate nohighlight">\(o\_ act\)</span>
in the formula above):</p>
<ul class="simple">
<li><strong>Hyperbolic tangent</strong>: Uses TanH kernel of the library (see <a class="reference internal" href="trans_tanh.html#tanh"><span class="std std-ref">TanH</span></a>).
Number of fractional bits for output tensor is the same as that for
tensors processed by TanH activation.</li>
<li><strong>Sigmoid</strong>: Uses Sigmoid kernel of the library (see <a class="reference internal" href="trans_sigmoid.html#sigmoid"><span class="std std-ref">Sigmoid</span></a>). Number
of fractional bits for output tensor is the same as that for tensors
processed by Sigmoid activation.</li>
<li><strong>No Activation</strong>: Passes data without modification.</li>
</ul>
<p>This kernel takes 7 tensors including input, weights, cell,
intermediate tensor from configuration structure and others (for full
list, see <a class="reference internal" href="#api-lstm"><span class="std std-ref">Kernel Interface</span></a>). It modifies only output tensor, cell tensors, and
intermediate tensor in processing.</p>
<p>Weights for cell is a single three-dimensional tensor of shape [4, <em>M</em>,
<em>M+N</em>]. Ensure that bias is of shape [4, M]. It represents stacking
of all weights sub tensors into one tensor in order (I, g, f, o):</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
\begin{matrix}
W_{\text{xi}} \\
W_{\text{xg}} \\
\begin{matrix}
W_{\text{xf}} \\
W_{\text{xo}} \\
\end{matrix} \\
\end{matrix} &amp; \begin{matrix}
W_{\text{hi}} \\
W_{\text{hg}} \\
\begin{matrix}
W_{\text{hf}} \\
W_{\text{ho}} \\
\end{matrix} \\
\end{matrix} \\
\end{bmatrix}\text{ }\end{split}\]</div>
<p>The first [M, <em>M+N]</em> sub-tensor of weights is applied to the input
gate, the second, to new cell candidates, the third, to the forget
gate, and the last, to the output gate.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<ul class="last simple">
<li>Ensure that you keep the same
order of sub-tensors for bias
tensor. For more information
about kernel parameters
requirements, see <a class="reference internal" href="#cond-lstm"><span class="std std-ref">Conditions for Applying the Kernel</span></a>.</li>
<li>Ensure that the configuration
structure (see <a class="reference internal" href="#fn-conf-lstm"><span class="std std-ref">Function Configuration Structure</span></a>) also
contains the pointer to
tensor, which is used by
kernel as intermediate result
tensor. This kernel modifies the
memory pointed to by the data,
shape, rank, element type, and
element parameters fields of
this tensor.</li>
<li>Ensure that the capacity of
the intermediate tensor is
enough to store M*4 elements
of input tensor type</li>
</ul>
</div>
<p>This kernel supports three modes of input processing:</p>
<ul class="simple">
<li><strong>One-to-one</strong><ul>
<li>Processes the input tensor as a single input frame</li>
<li>Ignores the shape of input tensor, and considers only the total
number of elements</li>
<li>Performs single step to produce one-dimensional output tensor of
shape [<em>M</em>]</li>
<li>Updates the memory pointed to by cell tensor, but does not modify
the tensor’s fields</li>
</ul>
</li>
<li><strong>Batch-to-batch</strong><ul>
<li>Processes the input tensor as a sequence of frames to produce a
sequence of outputs of the same size</li>
<li>Considers first dimension of input tensor as sequence size
(<code class="docutils literal notranslate"><span class="pre">batch_size</span></code>), and considers only the total number of elements
for the rest of the dimensions</li>
<li>Performs <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> steps to produce two-dimensional output tensor
of shape [<code class="docutils literal notranslate"><span class="pre">batch_size</span></code>, <em>M</em>]</li>
<li>Updates the memory pointed to by cell tensor, but does not modify
the tensor’s fields</li>
</ul>
</li>
<li><strong>Batch-to-last</strong><ul>
<li>Processes the input tensor as a sequence of frames to produce a
single (last in the sequence) output</li>
<li>Same as Batch-to-batch mode except that outputs tensor has a shape
[<em>M</em>] whose values are the same as those for the last sub
tensor in batch-to-batch mode</li>
</ul>
</li>
</ul>
<p>Dense part of calculations uses intermediate tensor for result, and
consequently output and previous output tensors might use the same
memory if it is acceptable to rewrite previous output data.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Ensure that you allocate memory
for the rest of the tensors
(including intermediate results
tensor) without overlaps.
Otherwise the behavior is
undefined.</p>
</div>
<div class="section" id="function-configuration-structure">
<span id="fn-conf-lstm"></span><h2>Function Configuration Structure<a class="headerlink" href="#function-configuration-structure" title="Permalink to this headline">¶</a></h2>
<p>LSTM cell kernel shares configuration structure with Basic RNN cell.
For more information see <a class="reference internal" href="comm_basic_rnn.html#fn-conf-brnn"><span class="std std-ref">Function Configuration Structure</span></a>.</p>
</div>
<div class="section" id="kernel-interface">
<span id="api-lstm"></span><h2>Kernel Interface<a class="headerlink" href="#kernel-interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="prototype">
<h3>Prototype<a class="headerlink" href="#prototype" title="Permalink to this headline">¶</a></h3>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mli_status</span> <span class="n">mli_krn_lstm_cell_</span><span class="o">&lt;</span><span class="n">data_type</span><span class="o">&gt;</span><span class="p">[</span><span class="n">_specialization</span><span class="p">](</span>
   <span class="n">const</span> <span class="n">mli_tensor</span> <span class="o">*</span><span class="ow">in</span><span class="p">,</span>
   <span class="n">const</span> <span class="n">mli_tensor</span> <span class="o">*</span><span class="n">prev_out</span><span class="p">,</span>
   <span class="n">const</span> <span class="n">mli_tensor</span> <span class="o">*</span><span class="n">weights</span><span class="p">,</span>
   <span class="n">const</span> <span class="n">mli_tensor</span> <span class="o">*</span><span class="n">bias</span><span class="p">,</span>
   <span class="n">const</span> <span class="n">mli_lstm_cell_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
   <span class="n">mli_tensor</span> <span class="o">*</span><span class="n">cell</span><span class="p">,</span>
   <span class="n">mli_tensor</span> <span class="o">*</span><span class="n">out</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="parameters">
<h3>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h3>
<table border="1" class="colwidths-given docutils" id="id1">
<caption><span class="caption-text">Kernel Interface Parameters</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Parameters</strong></th>
<th class="head"><strong>Description</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">in</span></code></td>
<td>[IN] Pointer to input
tensor</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">prev_out</span></code></td>
<td>[IN] Pointer to
previous output
tensor</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">weights</span></code></td>
<td>[IN] Pointer to
weights tensor</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">bias</span></code></td>
<td>[IN] Pointer to
biases tensor</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">cfg</span></code></td>
<td>[IN/OUT] Pointer to
configuration
structure</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">cell</span></code></td>
<td>[IN/OUT] Pointer to
cell state tensor</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">out</span></code></td>
<td>[OUT] Pointer to
output tensor</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="kernel-specializations">
<span id="kernel-specializations-1"></span><h2>Kernel Specializations<a class="headerlink" href="#kernel-specializations" title="Permalink to this headline">¶</a></h2>
<table border="1" class="colwidths-given docutils" id="id2">
<caption><span class="caption-text">Non-Specialized Functions</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Function</strong></th>
<th class="head"><strong>Description</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">mli_krn_lstm_cell_fx8</span></code></td>
<td>General function; 8bit FX
elements;</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">mli_krn_lstm_cell_fx16</span></code></td>
<td>General function; 16bit FX
elements;</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">mli_krn_lstm_cell_fx8w16d</span></code></td>
<td>General function; FX tensors
(8bit weights and biases, 16-bit
input, state, cell, output and
intermediate data);</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="conditions-for-applying-the-kernel">
<span id="cond-lstm"></span><h2>Conditions for Applying the Kernel<a class="headerlink" href="#conditions-for-applying-the-kernel" title="Permalink to this headline">¶</a></h2>
<p>Ensure that you satisfy the following conditions before applying the
function:</p>
<ul class="simple">
<li>Input, weights, bias, cell, and Previous output tensors must be valid
(see <a class="reference internal" href="../library_model/data.html#mli-tns-struct"><span class="std std-ref">mli_tensor Structure</span></a>)</li>
<li>Weights must be a three-dimensional tensor of shape [4, M, N+M]</li>
<li>Bias must be a two-dimensional tensor of shape [4, M]</li>
<li>Cell must be a one-dimensional tensor of shape [M]</li>
<li>Previous output must be a one-dimensional tensor of shape [M]</li>
<li>Element type of weights and bias tensors must be the same</li>
<li>Element type of input, cell, and previous output tensors must be the
same</li>
<li>The input tensor has the following restrictions:<ul>
<li>For <code class="docutils literal notranslate"><span class="pre">RNN_ONE_TO_ONE</span></code> mode, the total number of input and previous
output tensors elements (N+M) must be equal to the last dimension of the
weights tensor</li>
<li>For <code class="docutils literal notranslate"><span class="pre">RNN_BATCH_TO_BATCH</span></code> and <code class="docutils literal notranslate"><span class="pre">RNN_BATCH_TO_LAST</span></code> modes, the first
dimension of input reflects sequence length (batch size) while for
the rest of the input tensor dimensions, the same rules apply as
for <code class="docutils literal notranslate"><span class="pre">RNN_ONE_TO_ONE</span></code> mode</li>
</ul>
</li>
<li>The output tensor has the following restrictions:<ul>
<li>It must contain a valid pointer to a buffer with sufficient
capacity for storing the result (to keep M elements for
<code class="docutils literal notranslate"><span class="pre">RNN_ONE_TO_ONE</span></code> and <code class="docutils literal notranslate"><span class="pre">RNN_BATCH_TO_LAST</span></code> modes, and M*batch_size
elements for <code class="docutils literal notranslate"><span class="pre">RNN_BATCH_TO_BATCH</span></code> mode)</li>
<li>If <code class="docutils literal notranslate"><span class="pre">RNN_ACT_NONE</span></code> is used as output activation, output tensor must
contain a valid element parameter (<code class="docutils literal notranslate"><span class="pre">el_params.fx.frac_bits</span></code>) and it
must be the same as for the previous output tensor</li>
<li>Before processing, the output tensor does not have to contain a
valid shape, rank, or element type. These are filled by function
according to inputs and kernel processing mode. If <code class="docutils literal notranslate"><span class="pre">RNN_ACT_NONE</span></code> is
not used, the same applies to element parameter
(<code class="docutils literal notranslate"><span class="pre">el_params.fx.frac_bits</span></code>)</li>
<li>Before processing, intermediate result tensor in config structure
must contain a valid pointer to a buffer with sufficient capacity
for the result (4*M elements of input type)</li>
</ul>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="transform_grp.html" class="btn btn-neutral float-right" title="Transform Group" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="comm_basic_rnn.html" class="btn btn-neutral float-left" title="Basic RNN Cell" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Synopsys, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>